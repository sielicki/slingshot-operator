name: DKMS Kernel Module Builds

on:
  push:
    branches: [main]
    paths:
      - 'pkg/driveragent/**'
      - '.github/workflows/dkms-kernel-builds.yml'
  pull_request:
    branches: [main]
    paths:
      - 'pkg/driveragent/**'
      - '.github/workflows/dkms-kernel-builds.yml'
  workflow_dispatch:
    inputs:
      driver_tag:
        description: 'Driver tag to build (e.g., release/shs-12.0.2)'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25'

jobs:
  # ==========================================================================
  # Fetch and prepare the real CXI driver sources from HPE repositories
  # ==========================================================================
  prepare-driver-sources:
    name: Prepare CXI Driver Sources
    runs-on: ubuntu-latest
    outputs:
      driver_version: ${{ steps.get-version.outputs.version }}
      driver_tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Determine driver tag
        id: get-version
        run: |
          if [ -n "${{ github.event.inputs.driver_tag }}" ]; then
            TAG="${{ github.event.inputs.driver_tag }}"
          else
            # Fetch latest tag from shs-cxi-driver
            TAG=$(curl -s "https://api.github.com/repos/HewlettPackard/shs-cxi-driver/tags" | \
              jq -r '.[0].name')
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          # Extract version number from tag (e.g., release/shs-12.0.2 -> 12.0.2)
          VERSION=$(echo "$TAG" | sed 's/.*shs-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using driver tag: $TAG (version: $VERSION)"

      - name: Clone HPE Slingshot repositories
        run: |
          TAG="${{ steps.get-version.outputs.tag }}"
          echo "Cloning repositories at tag: $TAG"

          # Clone shs-cxi-driver
          git clone --depth 1 --branch "$TAG" \
            https://github.com/HewlettPackard/shs-cxi-driver.git

          # Clone ss-sbl (Slingshot Base Link - Cassini 1)
          git clone --depth 1 --branch "$TAG" \
            https://github.com/HewlettPackard/ss-sbl.git

          # Clone ss-link (Slingshot 2 Link - Cassini 2)
          git clone --depth 1 --branch "$TAG" \
            https://github.com/HewlettPackard/ss-link.git

      - name: Prepare combined source archive
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          mkdir -p cxi-driver-$VERSION

          # Copy driver sources
          cp -r shs-cxi-driver/* cxi-driver-$VERSION/

          # Place dependency sources where the build expects them
          # SBL needs to be at ../slingshot_base_link relative to cxi-driver
          cp -r ss-sbl cxi-driver-$VERSION/slingshot_base_link

          # SL driver needs to be at ../sl-driver relative to cxi-driver
          cp -r ss-link cxi-driver-$VERSION/sl-driver

          # Create the archive
          tar -czf cxi-driver-$VERSION.tar.gz cxi-driver-$VERSION

          ls -la cxi-driver-$VERSION.tar.gz

      - name: Upload driver sources
        uses: actions/upload-artifact@v4
        with:
          name: cxi-driver-sources
          path: cxi-driver-*.tar.gz
          retention-days: 1

  # ==========================================================================
  # Test DKMS builds on Ubuntu with multiple kernel versions
  # ==========================================================================
  dkms-ubuntu:
    name: DKMS Ubuntu ${{ matrix.version }} (kernel ${{ matrix.kernel }})
    needs: prepare-driver-sources
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: "24.04"
            image: ubuntu:24.04
            kernel: "6.8.0-generic"
            headers: linux-headers-6.8.0-51-generic
          - version: "22.04"
            image: ubuntu:22.04
            kernel: "5.15.0-generic"
            headers: linux-headers-5.15.0-130-generic
          - version: "22.04"
            image: ubuntu:22.04
            kernel: "6.5.0-hwe"
            headers: linux-headers-6.5.0-45-generic

    steps:
      - name: Download driver sources
        uses: actions/download-artifact@v4
        with:
          name: cxi-driver-sources
          path: .

      - name: Extract driver sources
        run: |
          tar -xzf cxi-driver-*.tar.gz
          rm -f cxi-driver-*.tar.gz
          mv cxi-driver-* cxi-driver

      - name: Test DKMS build on Ubuntu ${{ matrix.version }}
        run: |
          docker run --rm -v $PWD/cxi-driver:/cxi-driver ${{ matrix.image }} bash -c '
            set -e
            export DEBIAN_FRONTEND=noninteractive
            VERSION="${{ needs.prepare-driver-sources.outputs.driver_version }}"

            echo "=== Setting up Ubuntu ${{ matrix.version }} with kernel ${{ matrix.kernel }} ==="
            apt-get update
            apt-get install -y dkms build-essential kmod ${{ matrix.headers }} || {
              echo "Warning: Could not install specific kernel headers, trying generic"
              apt-get install -y linux-headers-generic
            }

            echo ""
            echo "=== Environment Info ==="
            echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)"
            echo "DKMS: $(dkms --version)"
            echo "CXI Driver Version: $VERSION"
            echo "Kernel headers available:"
            ls /lib/modules/ | head -5

            KVER=$(ls /lib/modules/ 2>/dev/null | head -1)
            echo "Using kernel: $KVER"

            if [ -z "$KVER" ]; then
              echo "Warning: No kernel headers found, skipping DKMS build test"
              exit 0
            fi

            if [ ! -e "/lib/modules/$KVER/build" ]; then
              echo "Error: /lib/modules/$KVER/build symlink missing"
              ls -la /lib/modules/$KVER/ || true
              exit 1
            fi

            echo ""
            echo "=== Building SBL (Slingshot Base Link) ==="
            cd /cxi-driver/slingshot_base_link
            export SBL_EXTERNAL_BUILD=1
            export KDIR=/lib/modules/$KVER/build

            # Build SBL - creates Module.symvers
            make KDIR=$KDIR || {
              echo "SBL build failed, checking structure..."
              find . -name "Makefile" -o -name "Kbuild" | head -10
              exit 1
            }

            echo ""
            echo "=== Building SL (Slingshot 2 Link) ==="
            cd /cxi-driver/sl-driver
            make KDIR=$KDIR || {
              echo "SL build failed"
              exit 1
            }

            echo ""
            echo "=== Building CXI Driver ==="
            cd /cxi-driver/drivers/net/ethernet/hpe/ss1

            # Export symbol paths for dependencies
            export KBUILD_EXTRA_SYMBOLS="/cxi-driver/slingshot_base_link/Module.symvers /cxi-driver/sl-driver/Module.symvers"

            make KDIR=$KDIR || {
              echo "CXI driver build failed"
              exit 1
            }

            echo ""
            echo "=== Build Results ==="
            find /cxi-driver -name "*.ko" -type f 2>/dev/null || echo "No .ko files found"

            echo ""
            echo "=== SUCCESS: CXI driver build completed on Ubuntu ${{ matrix.version }} ==="
          '

  # ==========================================================================
  # Test DKMS builds on RHEL-based distributions
  # ==========================================================================
  dkms-rhel:
    name: DKMS ${{ matrix.name }}
    needs: prepare-driver-sources
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Rocky Linux 9
            image: rockylinux:9
            pkg_manager: dnf
          - name: Rocky Linux 8
            image: rockylinux:8
            pkg_manager: dnf
          - name: AlmaLinux 9
            image: almalinux:9
            pkg_manager: dnf
          - name: Fedora Latest
            image: fedora:latest
            pkg_manager: dnf

    steps:
      - name: Download driver sources
        uses: actions/download-artifact@v4
        with:
          name: cxi-driver-sources
          path: .

      - name: Extract driver sources
        run: |
          tar -xzf cxi-driver-*.tar.gz
          rm -f cxi-driver-*.tar.gz
          mv cxi-driver-* cxi-driver

      - name: Test DKMS build on ${{ matrix.name }}
        run: |
          docker run --rm -v $PWD/cxi-driver:/cxi-driver ${{ matrix.image }} bash -c '
            set -e
            VERSION="${{ needs.prepare-driver-sources.outputs.driver_version }}"

            echo "=== Setting up ${{ matrix.name }} ==="
            ${{ matrix.pkg_manager }} install -y epel-release 2>/dev/null || true
            ${{ matrix.pkg_manager }} install -y dkms kernel-devel kernel-headers gcc make kmod elfutils-libelf-devel

            echo ""
            echo "=== Environment Info ==="
            echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)"
            echo "DKMS: $(dkms --version 2>/dev/null || echo checking...)"
            echo "CXI Driver Version: $VERSION"
            echo "Kernel headers available:"
            ls /lib/modules/ 2>/dev/null | head -5 || echo "No modules directory yet"

            KVER=$(ls /usr/src/kernels/ 2>/dev/null | head -1 || ls /lib/modules/ 2>/dev/null | head -1)
            echo "Using kernel: $KVER"

            if [ -z "$KVER" ]; then
              echo "Warning: No kernel headers found, skipping build test"
              exit 0
            fi

            # Setup build symlink if needed
            if [ -d "/usr/src/kernels/$KVER" ] && [ ! -e "/lib/modules/$KVER/build" ]; then
              echo "Creating /lib/modules/$KVER/build symlink..."
              mkdir -p /lib/modules/$KVER
              ln -sf /usr/src/kernels/$KVER /lib/modules/$KVER/build
            fi

            KDIR=/lib/modules/$KVER/build
            if [ ! -d "$KDIR" ] && [ -d "/usr/src/kernels/$KVER" ]; then
              KDIR=/usr/src/kernels/$KVER
            fi

            echo ""
            echo "=== Building SBL (Slingshot Base Link) ==="
            cd /cxi-driver/slingshot_base_link
            export SBL_EXTERNAL_BUILD=1

            make KDIR=$KDIR || {
              echo "SBL build failed"
              exit 1
            }

            echo ""
            echo "=== Building SL (Slingshot 2 Link) ==="
            cd /cxi-driver/sl-driver
            make KDIR=$KDIR || {
              echo "SL build failed"
              exit 1
            }

            echo ""
            echo "=== Building CXI Driver ==="
            cd /cxi-driver/drivers/net/ethernet/hpe/ss1
            export KBUILD_EXTRA_SYMBOLS="/cxi-driver/slingshot_base_link/Module.symvers /cxi-driver/sl-driver/Module.symvers"

            make KDIR=$KDIR || {
              echo "CXI driver build failed"
              exit 1
            }

            echo ""
            echo "=== Build Results ==="
            find /cxi-driver -name "*.ko" -type f 2>/dev/null || echo "No .ko files found"

            echo ""
            echo "=== SUCCESS: CXI driver build completed on ${{ matrix.name }} ==="
          '

  # ==========================================================================
  # Test DKMS builds on Debian/SUSE
  # ==========================================================================
  dkms-other:
    name: DKMS ${{ matrix.name }}
    needs: prepare-driver-sources
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Debian 12
            image: debian:12
            setup: |
              apt-get update
              apt-get install -y dkms linux-headers-amd64 build-essential kmod
          - name: Debian 11
            image: debian:11
            setup: |
              apt-get update
              apt-get install -y dkms linux-headers-amd64 build-essential kmod
          - name: openSUSE Leap 15
            image: opensuse/leap:15
            setup: |
              zypper refresh
              zypper install -y dkms kernel-default-devel gcc make kmod

    steps:
      - name: Download driver sources
        uses: actions/download-artifact@v4
        with:
          name: cxi-driver-sources
          path: .

      - name: Extract driver sources
        run: |
          tar -xzf cxi-driver-*.tar.gz
          rm -f cxi-driver-*.tar.gz
          mv cxi-driver-* cxi-driver

      - name: Test DKMS build on ${{ matrix.name }}
        run: |
          docker run --rm -v $PWD/cxi-driver:/cxi-driver ${{ matrix.image }} bash -c '
            set -e
            VERSION="${{ needs.prepare-driver-sources.outputs.driver_version }}"

            echo "=== Setting up ${{ matrix.name }} ==="
            ${{ matrix.setup }}

            echo ""
            echo "=== Environment Info ==="
            cat /etc/os-release | grep PRETTY_NAME
            dkms --version 2>/dev/null || echo "DKMS version check..."
            echo "CXI Driver Version: $VERSION"
            echo "Kernel headers available:"
            ls /lib/modules/ 2>/dev/null | head -5 || echo "No modules directory"
            ls /usr/src/kernels/ 2>/dev/null | head -5 || true

            KVER=$(ls /lib/modules/ 2>/dev/null | head -1)
            if [ -z "$KVER" ]; then
              KVER=$(ls /usr/src/kernels/ 2>/dev/null | head -1)
            fi
            echo "Using kernel: $KVER"

            if [ -z "$KVER" ]; then
              echo "Warning: No kernel headers found, skipping build test"
              exit 0
            fi

            # Setup build symlink if needed
            if [ -d "/usr/src/kernels/$KVER" ] && [ ! -e "/lib/modules/$KVER/build" ]; then
              echo "Creating /lib/modules/$KVER/build symlink..."
              mkdir -p /lib/modules/$KVER
              ln -sf /usr/src/kernels/$KVER /lib/modules/$KVER/build
            fi

            KDIR=/lib/modules/$KVER/build
            if [ ! -d "$KDIR" ] && [ -d "/usr/src/kernels/$KVER" ]; then
              KDIR=/usr/src/kernels/$KVER
            fi

            echo ""
            echo "=== Building SBL (Slingshot Base Link) ==="
            cd /cxi-driver/slingshot_base_link
            export SBL_EXTERNAL_BUILD=1

            make KDIR=$KDIR || {
              echo "SBL build failed"
              exit 1
            }

            echo ""
            echo "=== Building SL (Slingshot 2 Link) ==="
            cd /cxi-driver/sl-driver
            make KDIR=$KDIR || {
              echo "SL build failed"
              exit 1
            }

            echo ""
            echo "=== Building CXI Driver ==="
            cd /cxi-driver/drivers/net/ethernet/hpe/ss1
            export KBUILD_EXTRA_SYMBOLS="/cxi-driver/slingshot_base_link/Module.symvers /cxi-driver/sl-driver/Module.symvers"

            make KDIR=$KDIR || {
              echo "CXI driver build failed"
              exit 1
            }

            echo ""
            echo "=== Build Results ==="
            find /cxi-driver -name "*.ko" -type f 2>/dev/null || echo "No .ko files found"

            echo ""
            echo "=== SUCCESS: CXI driver build completed on ${{ matrix.name }} ==="
          '

  # ==========================================================================
  # Test driver-agent DKMS workflow logic
  # ==========================================================================
  test-driver-agent-dkms:
    name: Test Driver Agent DKMS Logic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Run driver-agent unit tests
        run: |
          go test -v ./pkg/driveragent/... -count=1

      - name: Build driver-agent
        run: |
          CGO_ENABLED=0 go build -o bin/driver-agent ./cmd/driver-agent

      - name: Verify driver-agent DKMS commands exist
        run: |
          ./bin/driver-agent --help

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: DKMS Build Summary
    needs: [prepare-driver-sources, dkms-ubuntu, dkms-rhel, dkms-other, test-driver-agent-dkms]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CXI Driver DKMS Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Driver Version:** ${{ needs.prepare-driver-sources.outputs.driver_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Driver Tag:** ${{ needs.prepare-driver-sources.outputs.driver_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Distribution Family | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu | ${{ needs.dkms-ubuntu.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RHEL-based | ${{ needs.dkms-rhel.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Debian/SUSE | ${{ needs.dkms-other.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Driver Agent Tests | ${{ needs.test-driver-agent-dkms.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Source Repositories" >> $GITHUB_STEP_SUMMARY
          echo "- [shs-cxi-driver](https://github.com/HewlettPackard/shs-cxi-driver)" >> $GITHUB_STEP_SUMMARY
          echo "- [ss-sbl](https://github.com/HewlettPackard/ss-sbl) (Slingshot Base Link)" >> $GITHUB_STEP_SUMMARY
          echo "- [ss-link](https://github.com/HewlettPackard/ss-link) (Slingshot 2 Link)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Distributions" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu 24.04, 22.04 (multiple kernels)" >> $GITHUB_STEP_SUMMARY
          echo "- Rocky Linux 8, 9" >> $GITHUB_STEP_SUMMARY
          echo "- AlmaLinux 9" >> $GITHUB_STEP_SUMMARY
          echo "- Fedora Latest" >> $GITHUB_STEP_SUMMARY
          echo "- Debian 11, 12" >> $GITHUB_STEP_SUMMARY
          echo "- openSUSE Leap 15" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        if: |
          needs.dkms-ubuntu.result == 'failure' ||
          needs.dkms-rhel.result == 'failure' ||
          needs.dkms-other.result == 'failure' ||
          needs.test-driver-agent-dkms.result == 'failure'
        run: |
          echo "Some DKMS builds failed!"
          exit 1
